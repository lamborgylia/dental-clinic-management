import React, { useState, useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { authService } from '../services/auth';
import TeethMap from '../components/TeethMap';

interface Patient {
  id: number;
  full_name: string;
  phone: string;
  iin: string;
  birth_date: string;
  created_at: string;
}

interface TreatmentPlan {
  id: number;
  patient_id: number;
  patient_name: string;
  diagnosis: string;
  treatment_description: string;
  created_at: string;
  status: string;
  services: number[];
  total_cost: number;
  selected_teeth: number[];
}

interface Appointment {
  id: number;
  patient_id: number;
  patient_name: string;
  doctor_id: number;
  appointment_date: string;
  appointment_time: string;
  status: string;
  notes: string;
}

interface Service {
  id: number;
  name: string;
  description: string;
  price: number;
  category: string;
  duration: string;
  complexity: string;
  is_active: boolean;
}

const PatientDashboard: React.FC = () => {
  const { patientId } = useParams<{ patientId: string }>();
  const navigate = useNavigate();
  const [patient, setPatient] = useState<Patient | null>(null);
  const [treatmentPlans, setTreatmentPlans] = useState<TreatmentPlan[]>([]);
  const [appointments, setAppointments] = useState<Appointment[]>([]);
  const [services, setServices] = useState<Service[]>([]);
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState<'overview' | 'treatment-plans' | 'appointments' | 'profile'>('overview');
  const [teethServices, setTeethServices] = useState<Record<number, number[]>>({});

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö –∑—É–±–æ–≤ —Å –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–º–∏ —É—Å–ª—É–≥–∞–º–∏ –∏–∑ –ø–ª–∞–Ω–æ–≤ –ª–µ—á–µ–Ω–∏—è
  const getAllTeethWithServices = () => {
    const allTeethServices: Record<number, number[]> = {};
    
    console.log('–ü–ª–∞–Ω—ã –ª–µ—á–µ–Ω–∏—è:', treatmentPlans);
    
    treatmentPlans.forEach(plan => {
      console.log(`–ü–ª–∞–Ω ${plan.id}: –∑—É–±—ã ${plan.selected_teeth}, —É—Å–ª—É–≥–∏ ${plan.services}`);
      plan.selected_teeth.forEach(toothId => {
        if (!allTeethServices[toothId]) {
          allTeethServices[toothId] = [];
        }
        plan.services.forEach(serviceId => {
          if (!allTeethServices[toothId].includes(serviceId)) {
            allTeethServices[toothId].push(serviceId);
          }
        });
      });
    });
    
    console.log('–ò—Ç–æ–≥–æ–≤—ã–µ –∑—É–±—ã —Å —É—Å–ª—É–≥–∞–º–∏:', allTeethServices);
    return allTeethServices;
  };

  // –û–±–Ω–æ–≤–ª—è–µ–º teethServices –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–ª–∞–Ω–æ–≤ –ª–µ—á–µ–Ω–∏—è
  useEffect(() => {
    const newTeethServices = getAllTeethWithServices();
    console.log('–û–±–Ω–æ–≤–ª—è–µ–º teethServices:', newTeethServices);
    setTeethServices(newTeethServices);
  }, [treatmentPlans]);

  useEffect(() => {
    fetchPatientData();
  }, [patientId]);

  const fetchPatientData = async () => {
    try {
      // –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
      const testPatient: Patient = {
        id: parseInt(patientId || '1'),
        full_name: '–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á',
        phone: '+7 (777) 123-45-67',
        iin: '030317123456',
        birth_date: '2003-03-17',
        created_at: '2024-01-15'
      };

      const testTreatmentPlans: TreatmentPlan[] = [
        {
          id: 1,
          patient_id: parseInt(patientId || '1'),
          patient_name: testPatient.full_name,
          diagnosis: '–ö–∞—Ä–∏–µ—Å –∑—É–±–æ–≤ 18, 21',
          treatment_description: '–õ–µ—á–µ–Ω–∏–µ –∫–∞—Ä–∏–µ—Å–∞, –ø–ª–æ–º–±–∏—Ä–æ–≤–∞–Ω–∏–µ',
          created_at: '2024-01-20',
          status: 'active',
          services: [1, 2],
          total_cost: 15000,
          selected_teeth: [18, 21]
        }
      ];

      const testAppointments: Appointment[] = [
        {
          id: 1,
          patient_id: parseInt(patientId || '1'),
          patient_name: testPatient.full_name,
          doctor_id: 1,
          appointment_date: '2024-01-25',
          appointment_time: '10:00',
          status: 'scheduled',
          notes: '–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –ø–æ –ø–ª–∞–Ω—É –ª–µ—á–µ–Ω–∏—è'
        },
        {
          id: 2,
          patient_id: parseInt(patientId || '1'),
          patient_name: testPatient.full_name,
          doctor_id: 1,
          appointment_date: '2024-01-20',
          appointment_time: '14:30',
          status: 'completed',
          notes: '–õ–µ—á–µ–Ω–∏–µ –∫–∞—Ä–∏–µ—Å–∞ –∑—É–±–æ–≤ 8, 9'
        }
      ];

      const testServices: Service[] = [
        {
          id: 1,
          name: '–õ–µ—á–µ–Ω–∏–µ –∫–∞—Ä–∏–µ—Å–∞',
          description: '–õ–µ—á–µ–Ω–∏–µ –∫–∞—Ä–∏–æ–∑–Ω—ã—Ö –ø–æ–ª–æ—Å—Ç–µ–π',
          price: 8000,
          category: 'therapy',
          duration: '30 –º–∏–Ω—É—Ç',
          complexity: '—Å—Ä–µ–¥–Ω—è—è',
          is_active: true
        },
        {
          id: 2,
          name: '–ü–ª–æ–º–±–∏—Ä–æ–≤–∞–Ω–∏–µ',
          description: '–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–ª–æ–º–±—ã',
          price: 7000,
          category: 'therapy',
          duration: '45 –º–∏–Ω—É—Ç',
          complexity: '—Å—Ä–µ–¥–Ω—è—è',
          is_active: true
        }
      ];

      setPatient(testPatient);
      setTreatmentPlans(testTreatmentPlans);
      setAppointments(testAppointments);
      setServices(testServices);
      setLoading(false);
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–∞—Ü–∏–µ–Ω—Ç–∞:', error);
      setLoading(false);
    }
  };

  const getPlanServices = (plan: TreatmentPlan) => {
    return plan.services || [];
  };

  const getPlanTotalCost = (plan: TreatmentPlan) => {
    return plan.total_cost || 0;
  };

  const getPlanSelectedTeeth = (plan: TreatmentPlan) => {
    return plan.selected_teeth || [];
  };

  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString('ru-RU');
  };

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'active': return '#059669';
      case 'completed': return '#2563eb';
      case 'cancelled': return '#dc2626';
      case 'scheduled': return '#f59e0b';
      default: return '#6b7280';
    }
  };

  const getStatusText = (status: string) => {
    switch (status) {
      case 'active': return '–ê–∫—Ç–∏–≤–µ–Ω';
      case 'completed': return '–ó–∞–≤–µ—Ä—à–µ–Ω';
      case 'cancelled': return '–û—Ç–º–µ–Ω–µ–Ω';
      case 'scheduled': return '–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω';
      default: return status;
    }
  };

  const handleLogout = () => {
    authService.logout();
    navigate('/login');
  };

  if (loading) {
    return (
      <div style={{ padding: '2rem', textAlign: 'center' }}>
        <div>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–∞—Ü–∏–µ–Ω—Ç–∞...</div>
      </div>
    );
  }

  if (!patient) {
    return (
      <div style={{ padding: '2rem', textAlign: 'center' }}>
        <div>–ü–∞—Ü–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω</div>
      </div>
    );
  }

  return (
    <div style={{ minHeight: '100vh', backgroundColor: '#f9fafb' }}>
      {/* Header */}
      <div style={{
        backgroundColor: 'white',
        padding: '1rem',
        boxShadow: '0 1px 3px rgba(0, 0, 0, 0.1)',
        display: 'flex',
        flexDirection: 'column',
        gap: '1rem'
      }}>
        <div style={{
          display: 'flex',
          flexDirection: 'column',
          gap: '0.5rem',
          alignItems: 'center',
          textAlign: 'center'
        }}>
          <h1 style={{ 
            margin: 0, 
            color: '#111827',
            fontSize: 'clamp(1.5rem, 4vw, 2rem)',
            lineHeight: '1.2'
          }}>
            –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –ø–∞—Ü–∏–µ–Ω—Ç–∞
          </h1>
          <p style={{ 
            margin: 0, 
            color: '#6b7280',
            fontSize: 'clamp(0.875rem, 3vw, 1rem)'
          }}>
            {patient.full_name}
          </p>
        </div>
        <div style={{ 
          display: 'flex', 
          gap: '0.5rem',
          justifyContent: 'center',
          flexWrap: 'wrap'
        }}>
          <button
            onClick={() => navigate('/doctor')}
            style={{
              backgroundColor: '#6b7280',
              color: 'white',
              border: 'none',
              padding: '0.75rem 1rem',
              borderRadius: '0.375rem',
              cursor: 'pointer',
              fontSize: 'clamp(0.875rem, 3vw, 1rem)',
              minWidth: '120px'
            }}
          >
            ‚Üê –ù–∞–∑–∞–¥ –∫ –≤—Ä–∞—á—É
          </button>
          <button
            onClick={handleLogout}
            style={{
              backgroundColor: '#dc2626',
              color: 'white',
              border: 'none',
              padding: '0.75rem 1rem',
              borderRadius: '0.375rem',
              cursor: 'pointer',
              fontSize: 'clamp(0.875rem, 3vw, 1rem)',
              minWidth: '80px'
            }}
          >
            –í—ã–π—Ç–∏
          </button>
        </div>
      </div>

      {/* Navigation */}
      <div style={{
        backgroundColor: 'white',
        borderBottom: '1px solid #e5e7eb',
        padding: '0 1rem',
        overflowX: 'auto'
      }}>
        <div style={{ 
          display: 'flex', 
          gap: '0.5rem',
          minWidth: 'max-content',
          padding: '0.5rem 0'
        }}>
          <button
            onClick={() => setActiveTab('overview')}
            style={{
              backgroundColor: activeTab === 'overview' ? '#2563eb' : 'transparent',
              color: activeTab === 'overview' ? 'white' : '#374151',
              border: 'none',
              padding: 'clamp(0.75rem, 2vw, 1rem) clamp(1rem, 3vw, 1.5rem)',
              cursor: 'pointer',
              borderBottom: activeTab === 'overview' ? '2px solid #2563eb' : 'none',
              fontSize: 'clamp(0.875rem, 3vw, 1rem)',
              whiteSpace: 'nowrap'
            }}
          >
            –û–±–∑–æ—Ä
          </button>
          <button
            onClick={() => setActiveTab('treatment-plans')}
            style={{
              backgroundColor: activeTab === 'treatment-plans' ? '#2563eb' : 'transparent',
              color: activeTab === 'treatment-plans' ? 'white' : '#374151',
              border: 'none',
              padding: 'clamp(0.75rem, 2vw, 1rem) clamp(1rem, 3vw, 1.5rem)',
              cursor: 'pointer',
              borderBottom: activeTab === 'treatment-plans' ? '2px solid #2563eb' : 'none',
              fontSize: 'clamp(0.875rem, 3vw, 1rem)',
              whiteSpace: 'nowrap'
            }}
          >
            –ü–ª–∞–Ω—ã –ª–µ—á–µ–Ω–∏—è
          </button>
          <button
            onClick={() => setActiveTab('appointments')}
            style={{
              backgroundColor: activeTab === 'appointments' ? '#2563eb' : 'transparent',
              color: activeTab === 'appointments' ? 'white' : '#374151',
              border: 'none',
              padding: 'clamp(0.75rem, 2vw, 1rem) clamp(1rem, 3vw, 1.5rem)',
              cursor: 'pointer',
              borderBottom: activeTab === 'appointments' ? '2px solid #2563eb' : 'none',
              fontSize: 'clamp(0.875rem, 3vw, 1rem)',
              whiteSpace: 'nowrap'
            }}
          >
            –ü—Ä–∏–µ–º—ã
          </button>
          <button
            onClick={() => setActiveTab('profile')}
            style={{
              backgroundColor: activeTab === 'profile' ? '#2563eb' : 'transparent',
              color: activeTab === 'profile' ? 'white' : '#374151',
              border: 'none',
              padding: 'clamp(0.75rem, 2vw, 1rem) clamp(1rem, 3vw, 1.5rem)',
              cursor: 'pointer',
              borderBottom: activeTab === 'profile' ? '2px solid #2563eb' : 'none',
              fontSize: 'clamp(0.875rem, 3vw, 1rem)',
              whiteSpace: 'nowrap'
            }}
          >
            –ü—Ä–æ—Ñ–∏–ª—å
          </button>
        </div>
      </div>

      {/* Content */}
      <div style={{ 
        padding: 'clamp(1rem, 4vw, 2rem)',
        maxWidth: '1200px',
        margin: '0 auto'
      }}>
                  {/* –û–±–∑–æ—Ä */}
          {activeTab === 'overview' && (
            <div>
              <h2 style={{ 
                marginBottom: 'clamp(1rem, 3vw, 1.5rem)', 
                color: '#111827',
                fontSize: 'clamp(1.5rem, 4vw, 2rem)'
              }}>–û–±–∑–æ—Ä</h2>
            
            <div style={{ 
              display: 'grid', 
              gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', 
              gap: 'clamp(1rem, 3vw, 1.5rem)', 
              marginBottom: '2rem' 
            }}>
              <div style={{ 
                backgroundColor: 'white', 
                padding: 'clamp(1rem, 3vw, 1.5rem)', 
                borderRadius: '0.5rem', 
                boxShadow: '0 1px 3px rgba(0, 0, 0, 0.1)' 
              }}>
                <h3 style={{ 
                  margin: '0 0 1rem 0', 
                  color: '#111827',
                  fontSize: 'clamp(1rem, 3vw, 1.125rem)'
                }}>üìã –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–ª–∞–Ω—ã –ª–µ—á–µ–Ω–∏—è</h3>
                <div style={{ 
                  fontSize: 'clamp(1.5rem, 5vw, 2rem)', 
                  fontWeight: 'bold', 
                  color: '#2563eb' 
                }}>
                  {treatmentPlans.filter(plan => plan.status === 'active').length}
                </div>
                <p style={{ 
                  margin: '0.5rem 0 0 0', 
                  color: '#6b7280',
                  fontSize: 'clamp(0.875rem, 3vw, 1rem)'
                }}>–ø–ª–∞–Ω–æ–≤ –≤ —Ä–∞–±–æ—Ç–µ</p>
              </div>
              
              <div style={{ 
                backgroundColor: 'white', 
                padding: 'clamp(1rem, 3vw, 1.5rem)', 
                borderRadius: '0.5rem', 
                boxShadow: '0 1px 3px rgba(0, 0, 0, 0.1)' 
              }}>
                <h3 style={{ 
                  margin: '0 0 1rem 0', 
                  color: '#111827',
                  fontSize: 'clamp(1rem, 3vw, 1.125rem)'
                }}>ü¶∑ –ó—É–±—ã –ø–æ–¥ –ª–µ—á–µ–Ω–∏–µ–º</h3>
                <div style={{ 
                  fontSize: 'clamp(1.5rem, 5vw, 2rem)', 
                  fontWeight: 'bold', 
                  color: '#059669' 
                }}>
                  {Object.keys(teethServices).length}
                </div>
                <p style={{ 
                  margin: '0.5rem 0 0 0', 
                  color: '#6b7280',
                  fontSize: 'clamp(0.875rem, 3vw, 1rem)'
                }}>–∑—É–±–æ–≤</p>
              </div>
              
              <div style={{ 
                backgroundColor: 'white', 
                padding: 'clamp(1rem, 3vw, 1.5rem)', 
                borderRadius: '0.5rem', 
                boxShadow: '0 1px 3px rgba(0, 0, 0, 0.1)' 
              }}>
                <h3 style={{ 
                  margin: '0 0 1rem 0', 
                  color: '#111827',
                  fontSize: 'clamp(1rem, 3vw, 1.125rem)'
                }}>üìÖ –ë–ª–∏–∂–∞–π—à–∏–π –ø—Ä–∏–µ–º</h3>
                <div style={{ 
                  fontSize: 'clamp(1.25rem, 4vw, 1.5rem)', 
                  fontWeight: 'bold', 
                  color: '#f59e0b' 
                }}>
                  {appointments.filter(apt => apt.status === 'scheduled').length > 0 ? 
                    formatDate(appointments.filter(apt => apt.status === 'scheduled')[0].appointment_date) : 
                    '–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π'
                  }
                </div>
                <p style={{ 
                  margin: '0.5rem 0 0 0', 
                  color: '#6b7280',
                  fontSize: 'clamp(0.875rem, 3vw, 1rem)'
                }}>—Å–ª–µ–¥—É—é—â–∏–π –≤–∏–∑–∏—Ç</p>
              </div>
            </div>

            {/* –ö–∞—Ä—Ç–∞ –∑—É–±–æ–≤ */}
            {treatmentPlans.length > 0 && (
              <div style={{ 
                backgroundColor: 'white', 
                padding: 'clamp(1rem, 3vw, 1.5rem)', 
                borderRadius: '0.5rem', 
                boxShadow: '0 1px 3px rgba(0, 0, 0, 0.1)' 
              }}>
                <h3 style={{ 
                  margin: '0 0 1rem 0', 
                  color: '#111827',
                  fontSize: 'clamp(1.125rem, 3vw, 1.25rem)'
                }}>ü¶∑ –ö–∞—Ä—Ç–∞ –∑—É–±–æ–≤</h3>
                <div style={{ 
                  overflowX: 'auto',
                  overflowY: 'hidden',
                  width: '100%',
                  minHeight: '450px'
                }}>
                  <TeethMap
                    selectedTeeth={[]}
                    onToothSelect={() => {}}
                    onClearSelection={() => {}}
                    services={services}
                    onAddServiceToTooth={() => {}}
                    onRemoveServiceFromTooth={() => {}}
                    teethServices={teethServices}
                  />
                </div>
                
                {/* –°–ø–∏—Å–æ–∫ –∑—É–±–æ–≤ —Å –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–º –ª–µ—á–µ–Ω–∏–µ–º */}
                {Object.keys(teethServices).length > 0 && (
                  <div style={{ 
                    marginTop: 'clamp(1rem, 3vw, 1.5rem)', 
                    padding: 'clamp(0.75rem, 2vw, 1rem)', 
                    backgroundColor: '#fef2f2', 
                    borderRadius: '0.375rem', 
                    border: '1px solid #fecaca' 
                  }}>
                    <h4 style={{ 
                      margin: '0 0 1rem 0', 
                      fontSize: 'clamp(1rem, 3vw, 1.125rem)', 
                      color: '#991b1b' 
                    }}>
                      üî¥ –ó—É–±—ã —Å –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–º –ª–µ—á–µ–Ω–∏–µ–º:
                    </h4>
                    <div style={{ 
                      display: 'grid', 
                      gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', 
                      gap: 'clamp(0.75rem, 2vw, 1rem)' 
                    }}>
                                              {Object.entries(teethServices).map(([toothId, serviceIds]) => (
                          <div key={toothId} style={{ 
                            padding: 'clamp(0.75rem, 2vw, 1rem)', 
                            backgroundColor: 'white', 
                            borderRadius: '0.375rem', 
                            border: '2px solid #ef4444',
                            boxShadow: '0 2px 4px rgba(239, 68, 68, 0.1)'
                          }}>
                            <div style={{ 
                              display: 'flex', 
                              alignItems: 'center', 
                              marginBottom: 'clamp(0.5rem, 2vw, 0.75rem)',
                              flexWrap: 'wrap',
                              gap: '0.5rem'
                            }}>
                              <div style={{
                                width: 'clamp(20px, 5vw, 24px)',
                                height: 'clamp(20px, 5vw, 24px)',
                                backgroundColor: '#ef4444',
                                color: 'white',
                                borderRadius: '50%',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontSize: 'clamp(0.75rem, 2vw, 0.875rem)',
                                fontWeight: 'bold',
                                flexShrink: 0
                              }}>
                                {toothId}
                              </div>
                              <strong style={{ 
                                color: '#991b1b', 
                                fontSize: 'clamp(1rem, 3vw, 1.125rem)'
                              }}>
                                –ó—É–± {toothId}
                              </strong>
                            </div>
                            
                            <div style={{ marginBottom: '0.5rem' }}>
                              <strong style={{ 
                                color: '#374151', 
                                fontSize: 'clamp(0.875rem, 3vw, 1rem)'
                              }}>–ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏:</strong>
                            </div>
                            
                            <div style={{ 
                              display: 'flex', 
                              flexDirection: 'column', 
                              gap: 'clamp(0.375rem, 1vw, 0.5rem)' 
                            }}>
                            {serviceIds.map(serviceId => {
                              const service = services.find(s => s.id === serviceId);
                              if (!service) return null;
                              
                              const getServiceColor = (category: string) => {
                                switch (category) {
                                  case 'therapy': return '#10b981';
                                  case 'surgery': return '#ef4444';
                                  case 'prosthetics': return '#f59e0b';
                                  case 'orthodontics': return '#8b5cf6';
                                  case 'hygiene': return '#06b6d4';
                                  default: return '#6b7280';
                                }
                              };
                              
                                                             return (
                                 <div key={serviceId} style={{
                                   padding: 'clamp(0.375rem, 1vw, 0.5rem)',
                                   backgroundColor: '#f9fafb',
                                   borderRadius: '0.25rem',
                                   border: `1px solid ${getServiceColor(service.category)}`,
                                   borderLeft: `4px solid ${getServiceColor(service.category)}`
                                 }}>
                                   <div style={{ 
                                     display: 'flex', 
                                     flexDirection: 'column',
                                     gap: '0.25rem'
                                   }}>
                                     <div style={{ 
                                       display: 'flex', 
                                       justifyContent: 'space-between', 
                                       alignItems: 'flex-start',
                                       flexWrap: 'wrap',
                                       gap: '0.5rem'
                                     }}>
                                       <div style={{ flex: 1, minWidth: '200px' }}>
                                         <div style={{ 
                                           fontWeight: '500', 
                                           color: '#111827', 
                                           fontSize: 'clamp(0.875rem, 3vw, 1rem)',
                                           lineHeight: '1.3'
                                         }}>
                                           {service.name}
                                         </div>
                                         <div style={{ 
                                           fontSize: 'clamp(0.75rem, 2vw, 0.875rem)', 
                                           color: '#6b7280', 
                                           marginTop: '0.125rem',
                                           lineHeight: '1.4'
                                         }}>
                                           {service.description}
                                         </div>
                                       </div>
                                       <div style={{ 
                                         textAlign: 'right',
                                         flexShrink: 0
                                       }}>
                                         <div style={{ 
                                           fontWeight: 'bold', 
                                           color: '#059669', 
                                           fontSize: 'clamp(0.875rem, 3vw, 1rem)'
                                         }}>
                                           {service.price.toLocaleString()} ‚Ç∏
                                         </div>
                                         <div style={{ 
                                           fontSize: 'clamp(0.75rem, 2vw, 0.875rem)', 
                                           color: '#6b7280' 
                                         }}>
                                           {service.duration}
                                         </div>
                                       </div>
                                     </div>
                                   </div>
                                 </div>
                               );
                            })}
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            )}
          </div>
        )}

        {/* –ü–ª–∞–Ω—ã –ª–µ—á–µ–Ω–∏—è */}
        {activeTab === 'treatment-plans' && (
          <div>
            <h2 style={{ 
              marginBottom: 'clamp(1rem, 3vw, 1.5rem)', 
              color: '#111827',
              fontSize: 'clamp(1.5rem, 4vw, 2rem)'
            }}>–ü–ª–∞–Ω—ã –ª–µ—á–µ–Ω–∏—è</h2>
            
            {treatmentPlans.length === 0 ? (
              <div style={{ 
                textAlign: 'center', 
                padding: 'clamp(2rem, 6vw, 3rem)', 
                color: '#6b7280' 
              }}>
                <div style={{ 
                  fontSize: 'clamp(2rem, 8vw, 3rem)', 
                  marginBottom: 'clamp(0.5rem, 2vw, 1rem)' 
                }}>üìã</div>
                <div style={{ fontSize: 'clamp(1rem, 3vw, 1.125rem)' }}>
                  –ü–ª–∞–Ω—ã –ª–µ—á–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
                </div>
              </div>
            ) : (
              <div style={{ display: 'grid', gap: 'clamp(0.75rem, 2vw, 1rem)' }}>
                                  {treatmentPlans.map(plan => (
                    <div key={plan.id} style={{ 
                      backgroundColor: 'white', 
                      padding: 'clamp(1rem, 3vw, 1.5rem)', 
                      borderRadius: '0.5rem', 
                      boxShadow: '0 1px 3px rgba(0, 0, 0, 0.1)',
                      border: '1px solid #e5e7eb'
                    }}>
                      <div style={{ 
                        display: 'flex', 
                        flexDirection: 'column',
                        gap: 'clamp(0.75rem, 2vw, 1rem)',
                        marginBottom: 'clamp(0.75rem, 2vw, 1rem)'
                      }}>
                        <div style={{
                          display: 'flex',
                          justifyContent: 'space-between',
                          alignItems: 'flex-start',
                          flexWrap: 'wrap',
                          gap: '1rem'
                        }}>
                          <div style={{ flex: 1, minWidth: '250px' }}>
                            <h3 style={{ 
                              margin: '0 0 0.5rem 0', 
                              color: '#111827',
                              fontSize: 'clamp(1.125rem, 3vw, 1.25rem)'
                            }}>–ü–ª–∞–Ω –ª–µ—á–µ–Ω–∏—è #{plan.id}</h3>
                            <p style={{ 
                              margin: '0 0 0.5rem 0', 
                              color: '#6b7280',
                              fontSize: 'clamp(0.875rem, 3vw, 1rem)',
                              lineHeight: '1.4'
                            }}>
                              <strong>–î–∏–∞–≥–Ω–æ–∑:</strong> {plan.diagnosis}
                            </p>
                            <p style={{ 
                              margin: '0 0 0.5rem 0', 
                              color: '#6b7280',
                              fontSize: 'clamp(0.875rem, 3vw, 1rem)',
                              lineHeight: '1.4'
                            }}>
                              <strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> {plan.treatment_description}
                            </p>
                          </div>
                          <span style={{
                            backgroundColor: getStatusColor(plan.status),
                            color: 'white',
                            padding: 'clamp(0.25rem, 1vw, 0.5rem) clamp(0.5rem, 2vw, 0.75rem)',
                            borderRadius: '1rem',
                            fontSize: 'clamp(0.75rem, 2vw, 0.875rem)',
                            fontWeight: '500',
                            whiteSpace: 'nowrap',
                            alignSelf: 'flex-start'
                          }}>
                            {getStatusText(plan.status)}
                          </span>
                        </div>
                    
                                          <div style={{ 
                        display: 'grid', 
                        gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', 
                        gap: 'clamp(0.75rem, 2vw, 1rem)', 
                        marginBottom: 'clamp(0.75rem, 2vw, 1rem)' 
                      }}>
                        <div>
                          <strong style={{ 
                            color: '#374151',
                            fontSize: 'clamp(0.875rem, 3vw, 1rem)'
                          }}>–ó—É–±—ã:</strong>
                          <div style={{ marginTop: '0.25rem' }}>
                            {getPlanSelectedTeeth(plan).map(toothId => (
                              <span key={toothId} style={{
                                display: 'inline-block',
                                backgroundColor: '#3b82f6',
                                color: 'white',
                                padding: 'clamp(0.125rem, 1vw, 0.25rem) clamp(0.25rem, 1vw, 0.5rem)',
                                borderRadius: '0.25rem',
                                margin: '0.125rem',
                                fontSize: 'clamp(0.75rem, 2vw, 0.875rem)'
                              }}>
                                {toothId}
                              </span>
                            ))}
                          </div>
                        </div>
                        
                        <div>
                          <strong style={{ 
                            color: '#374151',
                            fontSize: 'clamp(0.875rem, 3vw, 1rem)'
                          }}>–£—Å–ª—É–≥–∏:</strong>
                          <div style={{ marginTop: '0.25rem' }}>
                            {getPlanServices(plan).map(serviceId => {
                              const service = services.find(s => s.id === serviceId);
                              return service ? (
                                <div key={serviceId} style={{ 
                                  fontSize: 'clamp(0.875rem, 3vw, 1rem)', 
                                  color: '#6b7280',
                                  lineHeight: '1.4'
                                }}>
                                  {service.name} - {service.price.toLocaleString()} ‚Ç∏
                                </div>
                              ) : null;
                            })}
                          </div>
                        </div>
                        
                        <div>
                          <strong style={{ 
                            color: '#374151',
                            fontSize: 'clamp(0.875rem, 3vw, 1rem)'
                          }}>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</strong>
                          <div style={{ 
                            fontSize: 'clamp(1rem, 3vw, 1.125rem)', 
                            fontWeight: 'bold', 
                            color: '#059669', 
                            marginTop: '0.25rem' 
                          }}>
                            {getPlanTotalCost(plan).toLocaleString()} ‚Ç∏
                          </div>
                        </div>
                      </div>
                      
                      <div style={{ 
                        fontSize: 'clamp(0.875rem, 3vw, 1rem)', 
                        color: '#6b7280' 
                      }}>
                        –°–æ–∑–¥–∞–Ω: {formatDate(plan.created_at)}
                      </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        )}

        {/* –ü—Ä–∏–µ–º—ã */}
        {activeTab === 'appointments' && (
          <div>
            <h2 style={{ 
              marginBottom: 'clamp(1rem, 3vw, 1.5rem)', 
              color: '#111827',
              fontSize: 'clamp(1.5rem, 4vw, 2rem)'
            }}>–ò—Å—Ç–æ—Ä–∏—è –ø—Ä–∏–µ–º–æ–≤</h2>
            
            {appointments.length === 0 ? (
              <div style={{ 
                textAlign: 'center', 
                padding: 'clamp(2rem, 6vw, 3rem)', 
                color: '#6b7280' 
              }}>
                <div style={{ 
                  fontSize: 'clamp(2rem, 8vw, 3rem)', 
                  marginBottom: 'clamp(0.5rem, 2vw, 1rem)' 
                }}>üìÖ</div>
                <div style={{ fontSize: 'clamp(1rem, 3vw, 1.125rem)' }}>
                  –ü—Ä–∏–µ–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
                </div>
              </div>
            ) : (
              <div style={{
                backgroundColor: 'white',
                borderRadius: '0.5rem',
                boxShadow: '0 1px 3px rgba(0, 0, 0, 0.1)',
                overflow: 'auto'
              }}>
                <table style={{ 
                  width: '100%', 
                  borderCollapse: 'collapse',
                  minWidth: '600px'
                }}>
                  <thead>
                    <tr style={{ backgroundColor: '#f9fafb' }}>
                      <th style={{ 
                        padding: 'clamp(0.75rem, 2vw, 1rem)', 
                        textAlign: 'left', 
                        borderBottom: '1px solid #e5e7eb',
                        fontSize: 'clamp(0.875rem, 3vw, 1rem)'
                      }}>–î–∞—Ç–∞</th>
                      <th style={{ 
                        padding: 'clamp(0.75rem, 2vw, 1rem)', 
                        textAlign: 'left', 
                        borderBottom: '1px solid #e5e7eb',
                        fontSize: 'clamp(0.875rem, 3vw, 1rem)'
                      }}>–í—Ä–µ–º—è</th>
                      <th style={{ 
                        padding: 'clamp(0.75rem, 2vw, 1rem)', 
                        textAlign: 'left', 
                        borderBottom: '1px solid #e5e7eb',
                        fontSize: 'clamp(0.875rem, 3vw, 1rem)'
                      }}>–°—Ç–∞—Ç—É—Å</th>
                      <th style={{ 
                        padding: 'clamp(0.75rem, 2vw, 1rem)', 
                        textAlign: 'left', 
                        borderBottom: '1px solid #e5e7eb',
                        fontSize: 'clamp(0.875rem, 3vw, 1rem)'
                      }}>–ó–∞–º–µ—Ç–∫–∏</th>
                    </tr>
                  </thead>
                  <tbody>
                    {appointments.map(appointment => (
                      <tr key={appointment.id}>
                        <td style={{ 
                          padding: 'clamp(0.75rem, 2vw, 1rem)', 
                          borderBottom: '1px solid #e5e7eb',
                          fontSize: 'clamp(0.875rem, 3vw, 1rem)'
                        }}>
                          {formatDate(appointment.appointment_date)}
                        </td>
                        <td style={{ 
                          padding: 'clamp(0.75rem, 2vw, 1rem)', 
                          borderBottom: '1px solid #e5e7eb',
                          fontSize: 'clamp(0.875rem, 3vw, 1rem)'
                        }}>
                          {appointment.appointment_time}
                        </td>
                        <td style={{ 
                          padding: 'clamp(0.75rem, 2vw, 1rem)', 
                          borderBottom: '1px solid #e5e7eb'
                        }}>
                          <span style={{
                            backgroundColor: getStatusColor(appointment.status),
                            color: 'white',
                            padding: 'clamp(0.25rem, 1vw, 0.5rem) clamp(0.5rem, 2vw, 0.75rem)',
                            borderRadius: '1rem',
                            fontSize: 'clamp(0.75rem, 2vw, 0.875rem)',
                            whiteSpace: 'nowrap'
                          }}>
                            {getStatusText(appointment.status)}
                          </span>
                        </td>
                        <td style={{ 
                          padding: 'clamp(0.75rem, 2vw, 1rem)', 
                          borderBottom: '1px solid #e5e7eb', 
                          color: '#6b7280',
                          fontSize: 'clamp(0.875rem, 3vw, 1rem)'
                        }}>
                          {appointment.notes || '-'}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        )}

        {/* –ü—Ä–æ—Ñ–∏–ª—å */}
        {activeTab === 'profile' && (
          <div>
            <h2 style={{ 
              marginBottom: 'clamp(1rem, 3vw, 1.5rem)', 
              color: '#111827',
              fontSize: 'clamp(1.5rem, 4vw, 2rem)'
            }}>–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h2>
            
            <div style={{ 
              backgroundColor: 'white', 
              padding: 'clamp(1.5rem, 4vw, 2rem)', 
              borderRadius: '0.5rem', 
              boxShadow: '0 1px 3px rgba(0, 0, 0, 0.1)' 
            }}>
              <div style={{ 
                display: 'grid', 
                gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', 
                gap: 'clamp(1.5rem, 4vw, 2rem)' 
              }}>
                <div>
                  <h3 style={{ 
                    margin: '0 0 1rem 0', 
                    color: '#111827',
                    fontSize: 'clamp(1.125rem, 3vw, 1.25rem)'
                  }}>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                  
                  <div style={{ marginBottom: 'clamp(0.75rem, 2vw, 1rem)' }}>
                    <label style={{ 
                      display: 'block', 
                      marginBottom: '0.5rem', 
                      fontWeight: '500', 
                      color: '#374151',
                      fontSize: 'clamp(0.875rem, 3vw, 1rem)'
                    }}>
                      –§–ò–û:
                    </label>
                    <div style={{ 
                      padding: 'clamp(0.5rem, 2vw, 0.75rem)', 
                      backgroundColor: '#f9fafb', 
                      borderRadius: '0.375rem', 
                      border: '1px solid #e5e7eb',
                      fontSize: 'clamp(0.875rem, 3vw, 1rem)'
                    }}>
                      {patient.full_name}
                    </div>
                  </div>
                  
                  <div style={{ marginBottom: 'clamp(0.75rem, 2vw, 1rem)' }}>
                    <label style={{ 
                      display: 'block', 
                      marginBottom: '0.5rem', 
                      fontWeight: '500', 
                      color: '#374151',
                      fontSize: 'clamp(0.875rem, 3vw, 1rem)'
                    }}>
                      –¢–µ–ª–µ—Ñ–æ–Ω:
                    </label>
                    <div style={{ 
                      padding: 'clamp(0.5rem, 2vw, 0.75rem)', 
                      backgroundColor: '#f9fafb', 
                      borderRadius: '0.375rem', 
                      border: '1px solid #e5e7eb',
                      fontSize: 'clamp(0.875rem, 3vw, 1rem)'
                    }}>
                      {patient.phone}
                    </div>
                  </div>
                  
                  <div style={{ marginBottom: 'clamp(0.75rem, 2vw, 1rem)' }}>
                    <label style={{ 
                      display: 'block', 
                      marginBottom: '0.5rem', 
                      fontWeight: '500', 
                      color: '#374151',
                      fontSize: 'clamp(0.875rem, 3vw, 1rem)'
                    }}>
                      –ò–ò–ù:
                    </label>
                    <div style={{ 
                      padding: 'clamp(0.5rem, 2vw, 0.75rem)', 
                      backgroundColor: '#f9fafb', 
                      borderRadius: '0.375rem', 
                      border: '1px solid #e5e7eb',
                      fontSize: 'clamp(0.875rem, 3vw, 1rem)'
                    }}>
                      {patient.iin}
                    </div>
                  </div>
                </div>
                
                <div>
                  <h3 style={{ 
                    margin: '0 0 1rem 0', 
                    color: '#111827',
                    fontSize: 'clamp(1.125rem, 3vw, 1.25rem)'
                  }}>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                  
                  <div style={{ marginBottom: 'clamp(0.75rem, 2vw, 1rem)' }}>
                    <label style={{ 
                      display: 'block', 
                      marginBottom: '0.5rem', 
                      fontWeight: '500', 
                      color: '#374151',
                      fontSize: 'clamp(0.875rem, 3vw, 1rem)'
                    }}>
                      –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:
                    </label>
                    <div style={{ 
                      padding: 'clamp(0.5rem, 2vw, 0.75rem)', 
                      backgroundColor: '#f9fafb', 
                      borderRadius: '0.375rem', 
                      border: '1px solid #e5e7eb',
                      fontSize: 'clamp(0.875rem, 3vw, 1rem)'
                    }}>
                      {formatDate(patient.birth_date)}
                    </div>
                  </div>
                  
                  <div style={{ marginBottom: 'clamp(0.75rem, 2vw, 1rem)' }}>
                    <label style={{ 
                      display: 'block', 
                      marginBottom: '0.5rem', 
                      fontWeight: '500', 
                      color: '#374151',
                      fontSize: 'clamp(0.875rem, 3vw, 1rem)'
                    }}>
                      –î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:
                    </label>
                    <div style={{ 
                      padding: 'clamp(0.5rem, 2vw, 0.75rem)', 
                      backgroundColor: '#f9fafb', 
                      borderRadius: '0.375rem', 
                      border: '1px solid #e5e7eb',
                      fontSize: 'clamp(0.875rem, 3vw, 1rem)'
                    }}>
                      {formatDate(patient.created_at)}
                    </div>
                  </div>
                  
                  <div style={{ marginBottom: 'clamp(0.75rem, 2vw, 1rem)' }}>
                    <label style={{ 
                      display: 'block', 
                      marginBottom: '0.5rem', 
                      fontWeight: '500', 
                      color: '#374151',
                      fontSize: 'clamp(0.875rem, 3vw, 1rem)'
                    }}>
                      –í–æ–∑—Ä–∞—Å—Ç:
                    </label>
                    <div style={{ 
                      padding: 'clamp(0.5rem, 2vw, 0.75rem)', 
                      backgroundColor: '#f9fafb', 
                      borderRadius: '0.375rem', 
                      border: '1px solid #e5e7eb',
                      fontSize: 'clamp(0.875rem, 3vw, 1rem)'
                    }}>
                      {new Date().getFullYear() - new Date(patient.birth_date).getFullYear()} –ª–µ—Ç
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default PatientDashboard;
